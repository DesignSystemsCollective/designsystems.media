---
// src/components/media/MediaImage.astro

import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { formatDuration } from "../../utils/formatDuration";
import Badge from '../Badge.astro';
import { IMAGE_WIDTHS, IMAGE_SIZES } from "../../utils/imageSizes";

export interface Props {
  src?: string | ImageMetadata;
  alt: string;
  duration?: string;
  ratio?: 'square' | 'video';
  size?: 'small' | 'medium' | 'large' | 'thumbnail';
  class?: string;
  shadow?: 'shadow' | 'no-shadow';
  showDuration?: true | false;
  variant?: string;
  loading?: "lazy" | "eager";
}

const { src, alt, size, duration, shadow = 'shadow', ratio = 'square', showDuration = true, class: className = '', loading = 'lazy' } = Astro.props;

// Map sizes to widths and sizes for responsive images
const sizeToWidths: Record<string, readonly number[]> = {
  thumbnail: IMAGE_WIDTHS.thumbnail,
  small: IMAGE_WIDTHS.small,
  medium: IMAGE_WIDTHS.medium,
  large: IMAGE_WIDTHS.large,
};

const sizeToSizes: Record<string, string> = {
  thumbnail: IMAGE_SIZES.thumbnail,
  small: IMAGE_SIZES.small,
  medium: IMAGE_SIZES.medium,
  large: IMAGE_SIZES.large,
};

const currentSize = size || 'medium';
const widths = sizeToWidths[currentSize] || IMAGE_WIDTHS.medium;
const sizes = sizeToSizes[currentSize] || IMAGE_SIZES.medium;
const isImageMetadata = src && typeof src === 'object' && 'src' in src;

// Check if string is a local file path (not a remote URL)
const isLocalPath = (url: string): boolean => {
  return url.startsWith('./') || 
         url.startsWith('../') || 
         url.startsWith('/src/') ||
         url.startsWith('/@fs/') ||
         !url.startsWith('http://') && !url.startsWith('https://');
};

// Map sizes to width/height for remote images (string URLs)
const sizeToDimensions: Record<string, { width: number; height: number }> = {
  thumbnail: { width: 70, height: 70 },
  small: { width: 120, height: 120 },
  medium: { width: 320, height: 320 },
  large: { width: 640, height: 640 },
};

// Adjust height for video ratio
const dimensions = sizeToDimensions[currentSize] || sizeToDimensions.medium;
const imageHeight = ratio === 'video' 
  ? Math.round(dimensions.width * (9 / 16)) 
  : dimensions.height;
---

<div class={`media-image ${size} ${ratio} ${shadow} ${className}`}>
  {isImageMetadata ? (
    <Image 
      src={src as ImageMetadata} 
      alt={alt} 
      widths={[...widths]}
      sizes={sizes}
      loading={loading} 
    />
  ) : src && typeof src === 'string' ? (
    // Check if it's a local file path or remote URL
    isLocalPath(src) ? (
      // Local file paths cannot be used with Image component - must use img tag
      <img src={src} alt={alt} loading={loading} decoding="async" />
    ) : (
      // Remote URLs can use Image component with width/height
      <Image 
        src={src} 
        alt={alt} 
        width={dimensions.width}
        height={imageHeight}
        widths={[...widths]}
        sizes={sizes}
        loading={loading} 
      />
    )
  ) : null}
  {duration && showDuration && 
        <Badge 
            label={formatDuration(duration)}}
            variant='podcast-duration' 
          />}
</div>

<style>
  .media-image {
    position: relative;
    box-sizing: border-box;
    display: flex;
    height: fit-content;
    width: fit-content;
  }
  .media-image.no-shadow img{
    box-shadow: none;
  }
  .media-image.shadow img{
    box-shadow: 0 4px 8px var(--image-shadow), 
   0 0px 0px var(--image-shadow);
  }
  .media-image img {
    border-radius: 6px;
    overflow: hidden;
    border-radius: 6px;
    width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
.media-image.square img{
    aspect-ratio: auto 1/1;
}
.media-image.video {
    aspect-ratio: auto 16 / 9;
}
.media-image.video img{
    aspect-ratio: auto 16/9;
    object-fit: cover;
}
  /* Size variants */
  .media-image.thumbnail img{
    width: 70px;
    height: auto;
  }

  .media-image.small img{
    width: 120px;
    height: auto;
  }

  .media-image.medium img{
    width: 300px;
    height: auto;
  }

  .media-image.large img{
    width: 320px;
    height: auto;
  }

  /* Special class for podcast artwork in hero */
  .podcast-artwork img{
    border-radius: 12px;
  }

  .duration {
    font-variant: small-caps;
    position: absolute;
    display: inline-block;
    color: var(--tx);
    background: var(--bg-2);
    box-sizing: border-box;
    line-height: 1em;
    padding: 0.5em 0.5em 0.35em;
    border-radius: 0.4em;
    letter-spacing: 0.05em;
    font-size: 0.8rem;
    bottom: 0.5rem;
    right: 0.5rem;
  }

  @media screen and (max-width: 1024px) {
    .podcast-artwork {
      width: 150px;
      height: 150px;
    }
  }
</style>
